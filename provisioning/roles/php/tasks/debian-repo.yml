- name: debian-repo | Older version than PHP 5.6 are not supported since Jessie
  fail: msg="Older version than PHP 5.6 are not supported since Jessie"
  when: "ansible_lsb.major_release|int >= 8 and {{ php_version_installed | version_compare('5.6', '<') }}"

- name: debian-repo | Make sure APT supports HTTPS sources
  apt: pkg=apt-transport-https state=present
  become: yes

# https://www.dotdeb.org/instructions/
- name: debian-repo | Install DotDeb repository key on wheezy/squeeze
  apt_key: url=https://www.dotdeb.org/dotdeb.gpg
  become: yes
  when: "ansible_lsb.major_release|int < 8 and {{ php_version_installed | version_compare('5.4', '>') }}"

- name: debian-repo | Add DotDeb repository on wheezy/squeeze
  apt_repository: repo='{{ item }}' update_cache=yes
  with_items:
    - deb http://packages.dotdeb.org {{ ansible_distribution_release }} all
  become: yes
  when: "ansible_lsb.major_release|int < 8 and {{ php_version_installed | version_compare('5.4', '>') }}"

- name: debian-repo | Mark DotDeb repository as lower priority on wheezy/squeeze
  copy:
    dest: /etc/apt/preferences.d/packages_dotdeb_org
    content: |
      Package: *
      Pin: origin "packages.dotdeb.org"
      Pin-Priority: 100
  become: yes
  when: "ansible_lsb.major_release|int < 8 and {{ php_version_installed | version_compare('5.4', '>') }}"

# https://github.com/oerdnj/deb.sury.org/wiki/Frequently-Asked-Questions
- name: debian-repo | Install packages.sury.org repository key on jessie/stretch
  apt_key: id=AC0E47584A7A714D url=https://packages.sury.org/php/apt.gpg state=present
  when: "ansible_lsb.major_release|int >= 8"
  become: yes

- name: debian-repo | Add packages.sury.org repository on jessie/stretch
  apt_repository: repo='{{ item }}' update_cache=yes
  with_items:
    - deb https://packages.sury.org/php {{ ansible_distribution_release }} main
  become: yes
  when: "ansible_lsb.major_release|int >= 8"

- name: debian-repo | Mark packages.sury.org repository as lower priority on jessie/stretch
  copy:
    dest: /etc/apt/preferences.d/packages_sury_org
    content: |
      Package: *
      Pin: origin "packages.sury.org"
      Pin-Priority: 100
  become: yes
  when: "ansible_lsb.major_release|int >= 8"
